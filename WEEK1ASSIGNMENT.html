<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Letter Mosaic â€” Image to Random Letters</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f0f10; --fg:#e7e7ea; --panel:#1a1b1e; --border:#2a2c30; --accent:#8aa0ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;}
    .wrap{min-height:100%;display:grid;place-items:center;gap:14px;padding:14px;}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .toolbar>*{background:var(--panel);border:1px solid var(--border);color:var(--fg);
      padding:8px 12px;border-radius:10px;font-size:14px}
    button{cursor:pointer;transition:transform .06s ease}
    button:hover{transform:translateY(-1px);border-color:var(--accent)}
    label{user-select:none}
    canvas{max-width:min(92vw,780px);width:100%;height:auto;display:block;border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);background:#111}
    .note{opacity:.8;font-size:12px;text-align:center}
    input[type="file"]{background:transparent;border:none;padding:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button id="rerender">Shuffle Letters</button>
      <button id="uploadBtn">Upload Image</button>
      <label>Cell size:
        <input id="cell" type="range" min="4" max="16" value="7" />
        <span id="cellVal">7</span> px
      </label>
      <label>Contrast:
        <input id="contrast" type="range" min="0.6" max="2.0" value="1.25" step="0.05" />
        <span id="contrastVal">1.25</span>x
      </label>
      <label>Darkness threshold:
        <input id="threshold" type="range" min="40" max="200" value="130" />
        <span id="thresholdVal">130</span>
      </label>
    </div>

    <!-- Output canvas -->
    <canvas id="out" width="600" height="600"></canvas>
    <!-- Hidden canvas for pixel sampling -->
    <canvas id="src" width="600" height="600" style="display:none"></canvas>

    <!-- Hidden file input for uploads -->
    <input id="file" type="file" accept="image/*" style="display:none" />

    <div class="note">
      Tip: Put an image named <b>glass.png</b> in the same folder as this HTML or click <b>Upload Image</b>.
      Letters are randomized each render; use the sliders to tweak the effect.
    </div>
  </div>

  <script>
    // ============ Utilities ============
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const randLetter = () => LETTERS[(Math.random() * LETTERS.length) | 0];
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const lum = (r,g,b)=> 0.2126*r + 0.7152*g + 0.0722*b; // perceived luminance

    const out = document.getElementById('out');
    const src = document.getElementById('src');
    const octx = out.getContext('2d');
    const sctx = src.getContext('2d', { willReadFrequently: true });

    const cellEl = document.getElementById('cell');
    const contrEl = document.getElementById('contrast');
    const thrEl  = document.getElementById('threshold');
    const cellVal = document.getElementById('cellVal');
    const contrastVal = document.getElementById('contrastVal');
    const thresholdVal = document.getElementById('thresholdVal');

    const rerenderBtn = document.getElementById('rerender');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('file');

    // Keep track of the current image (HTMLImageElement)
    let currentImage = null;

    // Load an image by URL (same-origin recommended for GitHub Pages)
    function loadImage(url) {
      return new Promise((resolve, reject) => {
        const im = new Image();
        // same-origin on GitHub Pages; omit crossOrigin to avoid CORS tainting
        im.onload = () => resolve(im);
        im.onerror = (e) => reject(e);
        im.src = url;
      });
    }

    // Fit the image into our working canvases while preserving aspect ratio
    function drawSourceToCanvases(img) {
      const MAX = 600; // working resolution (affects detail)
      const scale = Math.min(MAX / img.width, MAX / img.height, 1);
      const w = Math.round(img.width  * scale);
      const h = Math.round(img.height * scale);

      // Resize both canvases to match
      src.width = out.width = w;
      src.height = out.height = h;

      sctx.clearRect(0, 0, w, h);
      sctx.drawImage(img, 0, 0, w, h);
    }

    function render() {
      if (!currentImage) return;

      const CELL = +cellEl.value;
      const CONTRAST = +contrEl.value;
      const THRESH = +thrEl.value;

      cellVal.textContent = CELL;
      contrastVal.textContent = CONTRAST.toFixed(2);
      thresholdVal.textContent = THRESH;

      const { width, height } = out;
      const data = sctx.getImageData(0, 0, src.width, src.height).data;

      // white background
      octx.clearRect(0, 0, width, height);
      octx.fillStyle = "#fff";
      octx.fillRect(0, 0, width, height);

      octx.textAlign = "center";
      octx.textBaseline = "middle";
      octx.fillStyle = "#000";

      for (let y = 0; y < height; y += CELL) {
        for (let x = 0; x < width; x += CELL) {
          const sx = clamp((x + (CELL >> 1)) | 0, 0, src.width - 1);
          const sy = clamp((y + (CELL >> 1)) | 0, 0, src.height - 1);
          const i = (sy * src.width + sx) * 4;
          const L = lum(data[i], data[i+1], data[i+2]); // 0..255
          const darkness = clamp((255 - L) * CONTRAST, 0, 255);

          if (darkness > THRESH) {
            const minF = CELL * 0.9, maxF = CELL * 1.6;
            const t = (darkness - THRESH) / (255 - THRESH);
            const fontSize = minF + (maxF - minF) * Math.pow(t, 0.85);
            octx.font = `${fontSize.toFixed(2)}px ui-monospace, monospace`;
            octx.fillText(randLetter(), x + CELL/2, y + CELL/2);
          }
        }
      }
    }

    // File upload handler
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const img = await loadImage(reader.result);
          currentImage = img;
          drawSourceToCanvases(currentImage);
          render();
        } catch (err) {
          console.error(err);
          alert("Failed to read the uploaded image.");
        }
      };
      reader.readAsDataURL(file);
    });

    uploadBtn.addEventListener('click', () => fileInput.click());
    rerenderBtn.addEventListener('click', render);
    cellEl.addEventListener('input', render);
    contrEl.addEventListener('input', render);
    thrEl.addEventListener('input', render);

    // Try to auto-load glass.png if present (same folder / same origin).
    (async function init() {
      try {
        const img = await loadImage("glass.png"); // <- put your image here
        currentImage = img;
        drawSourceToCanvases(currentImage);
        render();
      } catch {
        // If not found, ask the user to upload.
        console.log("glass.png not found. Use Upload Image.");
      }
    })();
  </script>
</body>
</html>
