<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Random-Letter Mosaic (IKEA Glass)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0f0f10; --fg:#e7e7ea; --panel:#1a1b1e; --border:#2a2c30; --accent:#8aa0ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace;}
    .wrap{min-height:100%;display:grid;place-items:center;gap:14px;padding:14px;}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .toolbar>*{background:var(--panel);border:1px solid var(--border);color:var(--fg);
      padding:8px 12px;border-radius:10px;font-size:14px}
    button{cursor:pointer;transition:transform .06s ease}
    button:hover{transform:translateY(-1px);border-color:var(--accent)}
    label{user-select:none}
    input[type="text"]{width:420px;background:#111;color:var(--fg);border:1px solid var(--border);
      padding:8px 10px;border-radius:10px}
    canvas{max-width:min(92vw,900px);width:100%;height:auto;display:block;border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);background:#111}
    .note{opacity:.8;font-size:12px;text-align:center}
    input[type="file"]{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button id="shuffleBtn">Shuffle Letters</button>
      <button id="uploadBtn">Upload Image</button>
      <label>Cell:
        <input id="cell" type="range" min="4" max="16" value="7" />
        <span id="cellVal">7</span>px
      </label>
      <label>Contrast:
        <input id="contrast" type="range" min="0.6" max="2.0" value="1.25" step="0.05" />
        <span id="contrastVal">1.25</span>x
      </label>
      <label>Threshold:
        <input id="threshold" type="range" min="40" max="200" value="130" />
        <span id="thresholdVal">130</span>
      </label>
    </div>

    <input id="file" type="file" accept="image/*" />
    <input id="urlInput" type="text"
      value="https://www.ikea.com.hk/dairyfarm/hk/images/126/0212627_PE366708_S4.jpg"
      title="Image URL (you can paste your own URL here)" />
    <div class="toolbar"><button id="loadUrlBtn">Load From URL</button></div>

    <!-- Output canvas -->
    <canvas id="out" width="700" height="700"></canvas>
    <!-- Hidden canvas for sampling -->
    <canvas id="src" width="700" height="700" style="display:none"></canvas>

    <div class="note">
      The app tries the direct URL first, then a CORS-friendly proxy. If both fail, click <b>Upload Image</b>.
      Use sliders to tweak the effect; <b>Shuffle Letters</b> randomizes characters.
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const randLetter = () => LETTERS[(Math.random() * LETTERS.length) | 0];
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const luminance = (r,g,b) => 0.2126*r + 0.7152*g + 0.0722*b;

    const out = document.getElementById('out');
    const src = document.getElementById('src');
    const octx = out.getContext('2d');
    const sctx = src.getContext('2d', { willReadFrequently: true });

    const cellEl = document.getElementById('cell');
    const contrEl = document.getElementById('contrast');
    const thrEl  = document.getElementById('threshold');
    const cellVal = document.getElementById('cellVal');
    const contrastVal = document.getElementById('contrastVal');
    const thresholdVal = document.getElementById('thresholdVal');
    const shuffleBtn = document.getElementById('shuffleBtn');

    const fileInput = document.getElementById('file');
    const uploadBtn = document.getElementById('uploadBtn');
    const urlInput  = document.getElementById('urlInput');
    const loadUrlBtn = document.getElementById('loadUrlBtn');

    let currentImage = null;

    function weservUrl(u) {
      // Use a public image proxy that adds CORS headers.
      const noScheme = u.replace(/^https?:\/\//, "");
      return "https://images.weserv.nl/?url=" + encodeURIComponent(noScheme);
    }

    function loadImage(url, allowCORS = true) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        if (allowCORS) img.crossOrigin = "anonymous"; // request CORS if possible
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error("Image load failed: " + url));
        img.src = url;
      });
    }

    async function loadWithFallbacks(url) {
      // Try original (CORS), then proxy, then throw.
      try {
        return await loadImage(url, true);
      } catch(_) {
        try {
          return await loadImage(weservUrl(url), true);
        } catch(e2) {
          throw e2;
        }
      }
    }

    function fitAndDrawToSource(img) {
      const MAX = 700;
      const scale = Math.min(MAX / img.width, MAX / img.height, 1);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      src.width = out.width = w;
      src.height = out.height = h;
      sctx.clearRect(0,0,w,h);
      sctx.drawImage(img, 0, 0, w, h);
    }

    function render() {
      if (!currentImage) return;
      const CELL = +cellEl.value;
      const CONTRAST = +contrEl.value;
      const THRESH = +thrEl.value;

      cellVal.textContent = CELL;
      contrastVal.textContent = CONTRAST.toFixed(2);
      thresholdVal.textContent = THRESH;

      const { width, height } = out;
      const data = sctx.getImageData(0, 0, src.width, src.height).data;

      octx.clearRect(0,0,width,height);
      octx.fillStyle = "#fff";
      octx.fillRect(0,0,width,height);

      octx.textAlign = "center";
      octx.textBaseline = "middle";
      octx.fillStyle = "#000";

      for (let y = 0; y < height; y += CELL) {
        for (let x = 0; x < width; x += CELL) {
          const sx = clamp((x + (CELL >> 1)) | 0, 0, src.width - 1);
          const sy = clamp((y + (CELL >> 1)) | 0, 0, src.height - 1);
          const i = (sy * src.width + sx) * 4;
          const L = luminance(data[i], data[i+1], data[i+2]); // 0..255
          const darkness = clamp((255 - L) * CONTRAST, 0, 255);

          if (darkness > THRESH) {
            const minF = CELL * 0.9, maxF = CELL * 1.6;
            const t = (darkness - THRESH) / (255 - THRESH);
            const fontSize = minF + (maxF - minF) * Math.pow(t, 0.85);
            octx.font = `${fontSize.toFixed(2)}px ui-monospace, monospace`;
            octx.fillText(randLetter(), x + CELL/2, y + CELL/2);
          }
        }
      }
    }

    // -------- Event wiring --------
    shuffleBtn.addEventListener('click', render);
    cellEl.addEventListener('input', render);
    contrEl.addEventListener('input', render);
    thrEl.addEventListener('input', render);

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          const img = await loadImage(reader.result, true);
          currentImage = img;
          fitAndDrawToSource(currentImage);
          render();
        } catch (err) {
          console.error(err);
          alert("Failed to read the uploaded image.");
        }
      };
      reader.readAsDataURL(file);
    });

    async function loadFromUrlBox() {
      const url = urlInput.value.trim();
      if (!url) return;
      try {
        const img = await loadWithFallbacks(url);
        currentImage = img;
        fitAndDrawToSource(currentImage);
        render();
      } catch (err) {
        console.error(err);
        alert("Could not load the image from URL.\nTry clicking Upload Image and select the same picture from your computer.");
      }
    }
    loadUrlBtn.addEventListener('click', loadFromUrlBox);

    // Auto-load the provided IKEA URL on first open
    (async function init() {
      await loadFromUrlBox();
    })();
  </script>
</body>
</html>
